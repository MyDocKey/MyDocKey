<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MyDocKey</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<style>
  *{box-sizing:border-box;margin:0;padding:0;font-family:'Inter',sans-serif;}
  body{background:linear-gradient(135deg,#4f46e5,#3b82f6);display:flex;justify-content:center;align-items:center;min-height:100vh;padding:1rem;}
  .card{background:rgba(255,255,255,0.1);backdrop-filter:blur(12px);border-radius:20px;padding:2rem;width:100%;max-width:450px;text-align:center;box-shadow:0 8px 30px rgba(0,0,0,0.2);color:white;animation:fadeIn 0.4s ease-out forwards;border:1px solid rgba(255,255,255,0.2);}
  .logo-container{display:flex;justify-content:center;align-items:center;gap:10px;margin-bottom:1rem;}
  .doc-icon{width:24px;height:28px;border:2px solid #fff;border-radius:3px;position:relative;}
  .doc-icon::before{content:"";position:absolute;width:12px;height:2px;background:white;top:6px;left:4px;border-radius:1px;box-shadow:0 6px white,0 12px white;}
  .lock-icon{width:20px;height:20px;border:2px solid #10b981;border-radius:4px;position:relative;background:rgba(16,185,129,0.2);transform:translateY(4px);}
  .lock-icon::before{content:"";position:absolute;top:-8px;left:4px;width:8px;height:8px;border:2px solid #10b981;border-radius:50%;}
  .logo-text{font-size:1.5rem;font-weight:700;letter-spacing:0.5px;}
  p.subtitle{font-size:0.9rem;margin-bottom:1rem;opacity:0.85;}
  .tabs{display:flex;justify-content:center;background:rgba(255,255,255,0.15);border-radius:12px;margin-bottom:1.5rem;overflow:hidden;}
  .tab{flex:1;padding:0.7rem;cursor:pointer;font-weight:bold;transition:0.3s;}
  .tab.active{background:white;color:#2563eb;box-shadow:0 2px 4px rgba(0,0,0,0.1);}
  .tab-content{display:none;}
  .tab-content.active{display:block;}
  input,button{width:100%;padding:0.8rem;margin-bottom:0.8rem;border:none;border-radius:12px;font-size:1rem;}
  input{background:rgba(255,255,255,0.85);color:black;}
  button{background:white;color:#2563eb;font-weight:bold;cursor:pointer;transition:0.2s;}
  button:hover{background:#e0e7ff;}
  label{display:block;margin-bottom:0.3rem;font-size:0.9rem;font-weight:600;text-align:left;}
  a.download-btn{display:inline-block;margin-top:1rem;padding:0.8rem 1.5rem;background:#10b981;color:white;font-weight:bold;border-radius:12px;text-decoration:none;transition:background 0.2s;}
  a.download-btn:hover{background:#059669;}
  .helpdesk{font-size:0.8rem;margin-top:0.8rem;color:#e0e7ff;opacity:0.85;}
  .credit{font-size:0.65rem;opacity:0.6;margin-top:0.5rem;}
  .toast{position:fixed;bottom:20px;right:20px;background:white;color:black;padding:12px 18px;border-radius:10px;box-shadow:0 4px 10px rgba(0,0,0,0.2);display:none;font-weight:600;z-index:10000;}
  .toast.show{display:block;}
  @keyframes fadeIn{from{opacity:0;transform:scale(0.95);}to{opacity:1;transform:scale(1);}}
</style>
</head>
<body>

<div class="card">
  <div class="logo-container">
    <div class="doc-icon"></div>
    <div class="lock-icon"></div>
    <div class="logo-text">MyDocKey</div>
  </div>
  <p class="subtitle">Securely upload & access your files — no Google login required.</p>

  <div class="tabs">
    <div class="tab active" data-tab="upload">Upload</div>
    <div class="tab" data-tab="download">Download</div>
  </div>

  <!-- Upload Tab -->
  <div class="tab-content active" id="upload">
    <input id="username" type="text" placeholder="Choose a Unique Username" required>
    <input id="password" type="password" placeholder="Set Password for this file" required>
    <input id="file" type="file" required>
    <label for="expiry">Select Expiry Date</label>
    <input id="expiry" type="date" required>
    <button id="upload-btn">Upload File</button>
  </div>

  <!-- Download Tab -->
  <div class="tab-content" id="download">
    <input id="dl-username" type="text" placeholder="Enter Username" required>
    <input id="dl-password" type="password" placeholder="Enter Password" required>
    <button id="download-btn">Access & Download</button>
    <div id="download-link"></div>
  </div>

  <p class="helpdesk">Helpdesk: <a href="mailto:helpdesk.mydockey@yahoo.com" style="color:#fff;text-decoration:underline;">helpdesk.mydockey@yahoo.com</a></p>
  <p class="credit">Created by Shubham (BCA student)</p>
</div>

<div id="toast" class="toast"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

// For Firebase JS SDK v7.20.0 and later, measurementId is optional
const firebaseConfig = {
  apiKey: "AIzaSyBNMO68Z3fHDUPSMluGdem7tiXFitPJ9Xs",
  authDomain: "mydockey-23982.firebaseapp.com",
  projectId: "mydockey-23982",
  storageBucket: "mydockey-23982.firebasestorage.app",
  messagingSenderId: "326486846589",
  appId: "1:326486846589:web:9d715e2085574cd668d514",
  measurementId: "G-K9PN9WQLCX"
};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const storage = getStorage(app);

let currentUser = null;

// Toast helper
function showToast(msg) {
  const toast = document.getElementById("toast");
  toast.textContent = msg;
  toast.classList.add("show");
  setTimeout(()=>toast.classList.remove("show"),3000);
}

// Sign in anonymously
async function initAuth(){
  try {
    const userCredential = await signInAnonymously(auth);
    currentUser = userCredential.user;
    console.log("Signed in anonymously:",currentUser.uid);
  } catch(e){
    console.error("Firebase auth failed:",e);
    showToast("⚠️ Firebase authentication failed");
  }
}
initAuth();

// Tab switching
document.querySelectorAll('.tab').forEach(tab=>{
  tab.addEventListener('click',()=>{
    document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active'));
    tab.classList.add('active');
    document.getElementById(tab.dataset.tab).classList.add('active');
  });
});

// Upload
document.getElementById('upload-btn').addEventListener('click', async ()=>{
  if(!currentUser){ showToast("⚠️ Waiting for authentication"); return; }
  const username=document.getElementById('username').value.trim();
  const password=document.getElementById('password').value.trim();
  const fileInput=document.getElementById('file');
  const expiry=document.getElementById('expiry').value;
  if(!username||!password||!fileInput.files.length||!expiry){ showToast("⚠️ Fill all fields"); return; }
  try{
    showToast("⏳ Uploading...");
    const file=fileInput.files[0];
    const path=`files/${username}/${file.name}`;
    await uploadBytes(ref(storage,path),file);
    await setDoc(doc(db,'files',username),{
      password:btoa(password),
      filePath:path,
      fileName:file.name,
      expiry:expiry,
      uploadedAt:new Date().toISOString(),
      uploadedByUid:currentUser.uid
    });
    showToast("✅ File uploaded!");
    document.getElementById('username').value='';
    document.getElementById('password').value='';
    document.getElementById('file').value='';
  }catch(e){console.error(e); showToast("❌ Upload failed");}
});

// Download
document.getElementById('download-btn').addEventListener('click', async ()=>{
  if(!currentUser){ showToast("⚠️ Waiting for authentication"); return; }
  const username=document.getElementById('dl-username').value.trim();
  const password=document.getElementById('dl-password').value.trim();
  const downloadDiv=document.getElementById('download-link');
  downloadDiv.innerHTML='';
  if(!username||!password){ showToast("⚠️ Enter username & password"); return; }
  try{
    showToast("⏳ Checking...");
    const docSnap=await getDoc(doc(db,'files',username));
    if(!docSnap.exists()){ showToast("❌ File not found"); return; }
    const data=docSnap.data();
    if(btoa(password)!==data.password){ showToast("❌ Incorrect password"); return; }
    const today=new Date().toISOString().split('T')[0];
    if(data.expiry<today){ showToast("⏳ File expired"); return; }
    const fileURL=await getDownloadURL(ref(storage,data.filePath));
    downloadDiv.innerHTML=`<a class="download-btn" href="${fileURL}" download="${data.fileName}">⬇ Download ${data.fileName}</a>`;
    showToast("✅ Download ready!");
  }catch(e){console.error(e); showToast("❌ Access failed");}
});

// Set expiry min date
window.addEventListener('load',()=>{
  const d=new Date();
  d.setDate(d.getDate()+1);
  const tomorrow=d.toISOString().split('T')[0];
  document.getElementById('expiry').min=tomorrow;
  document.getElementById('expiry').value=tomorrow;
});
</script>
</body>
</html>
