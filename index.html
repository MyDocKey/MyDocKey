<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MyDocKey - Streamlined Access</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<style>
  :root {
    --bg-grad-start: #4f46e5; --bg-grad-end: #3b82f6; --card-bg: rgba(255,255,255,0.1);
    --text-color: white; --input-bg: rgba(255,255,255,0.85); --input-text: black;
    --button-bg: white; --button-text: #2563eb; --button-hover: #e0e7ff;
    --tab-bg: rgba(255,255,255,0.15); --tab-active-bg: white; --tab-active-text: #2563eb;
    --success-color: #10b981; --success-hover: #059669; --border-color: rgba(255,255,255,0.2);
    --shadow-color: rgba(0,0,0,0.2); --danger-color: #ef4444; --danger-hover: #dc2626;
  }
  [data-theme="dark"] {
    --bg-grad-start: #1f2937; --bg-grad-end: #111827; --card-bg: rgba(31,41,55,0.5);
    --text-color: #e5e7eb; --input-bg: rgba(55,65,81,0.8); --input-text: white;
    --button-bg: #3b82f6; --button-text: white; --button-hover: #2563eb;
    --tab-bg: rgba(55,65,81,0.5); --tab-active-bg: #3b82f6; --tab-active-text: white;
    --border-color: rgba(255,255,255,0.1); --shadow-color: rgba(0,0,0,0.4);
  }
  *{box-sizing:border-box;margin:0;padding:0;font-family:'Inter',sans-serif;transition: background 0.3s, color 0.3s;}
  body{background:linear-gradient(135deg, var(--bg-grad-start), var(--bg-grad-end));display:flex;justify-content:center;align-items:center;min-height:100vh;padding:1rem;}
  .card{background:var(--card-bg);backdrop-filter:blur(12px);border-radius:20px;padding:2rem;width:100%;max-width:450px;text-align:center;box-shadow:0 8px 30px var(--shadow-color);color:var(--text-color);border:1px solid var(--border-color); position: relative; overflow: hidden; padding-bottom: 5rem;}
  .logo-container{display:flex;justify-content:center;align-items:center;gap:10px;margin-bottom:1rem;}
  .doc-icon{width:24px;height:28px;border:2px solid var(--text-color);border-radius:3px;position:relative;}
  .doc-icon::before{content:"";position:absolute;width:12px;height:2px;background:var(--text-color);top:6px;left:4px;border-radius:1px;box-shadow:0 6px var(--text-color),0 12px var(--text-color);}
  .lock-icon{width:20px;height:20px;border:2px solid var(--success-color);border-radius:4px;position:relative;background:rgba(16,185,129,0.2);transform:translateY(4px);}
  .lock-icon::before{content:"";position:absolute;top:-8px;left:4px;width:8px;height:8px;border:2px solid var(--success-color);border-radius:50%;}
  .logo-text{font-size:1.5rem;font-weight:700;letter-spacing:0.5px;}
  p.subtitle{font-size:0.9rem;margin-bottom:1rem;opacity:0.85;}
  .tabs{display:flex;justify-content:center;background:var(--tab-bg);border-radius:12px;margin-bottom:1.5rem;overflow:hidden;}
  .tab{flex:1;padding:0.7rem;cursor:pointer;font-weight:bold;transition:0.3s;}
  .tab.active{background:var(--tab-active-bg);color:var(--tab-active-text);box-shadow:0 2px 4px rgba(0,0,0,0.1);}
  .tab-content{display:none;}
  .tab-content.active{display:block; animation: fadeIn 0.5s;}
  @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
  @keyframes slideInUp { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }
  input,button{width:100%;padding:0.8rem;margin-bottom:0.8rem;border:none;border-radius:12px;font-size:1rem;}
  input{background:var(--input-bg);color:var(--input-text);}
  input::placeholder {color: var(--input-text); opacity: 0.6;}
  button{background:var(--button-bg);color:var(--button-text);font-weight:bold;cursor:pointer;transition:all 0.2s;transform:scale(1);}
  button:hover:not(:disabled){background:var(--button-hover); transform:scale(1.02);}
  button:active:not(:disabled) { transform: scale(0.98); }
  button:disabled { background: #9ca3af; cursor: not-allowed; }
  label{display:block;margin-bottom:0.3rem;font-size:0.9rem;font-weight:600;text-align:left;}
  a {color: var(--text-color); text-decoration: underline;}
  .footer-container { position: absolute; bottom: 12px; left: 0; right: 0; width: 100%; }
  .helpdesk { font-size: 0.8rem; opacity: 0.85; margin-bottom: 4px; }
  .credit { font-size: 0.6rem; opacity: 0.5; }
  .toast{position:fixed;bottom:20px;right:20px;background:var(--button-bg);color:var(--button-text);padding:12px 18px;border-radius:10px;box-shadow:0 4px 10px rgba(0,0,0,0.2);transform:translateX(calc(100% + 20px));transition:transform 0.4s;font-weight:600;z-index:10000;}
  .toast.show{transform:translateX(0);}
  .theme-switcher { position: fixed; top: 20px; right: 20px; cursor: pointer; z-index: 1001;}
  .theme-switcher svg { width: 24px; height: 24px; color: white; }
  .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); backdrop-filter: blur(5px); display: none; justify-content: center; align-items: center; z-index: 2000; animation: fadeIn 0.3s; }
  .modal-content { background: var(--card-bg); color: var(--text-color); border: 1px solid var(--border-color); padding: 2rem; border-radius: 20px; max-width: 480px; width: 90%; text-align: left; animation: slideInUp 0.4s; }
  .modal-content h3 { margin-bottom: 1rem; }
  .modal-content p { margin-bottom: 0.5rem; opacity: 0.9; line-height: 1.6; }
  .modal-buttons { display: flex; gap: 1rem; margin-top: 1.5rem; }
  .modal-buttons button { margin-bottom: 0; }
  .modal-footer { margin-top: 1.5rem; font-size: 0.8rem; display: flex; align-items: center; }
  .modal-footer input { width: auto; margin: 0 0.5rem 0 0; }
  #drop-zone { border: 2px dashed var(--border-color); border-radius: 12px; padding: 1.5rem; margin-bottom: 0.8rem; transition: background 0.3s, border-color 0.3s; }
  #drop-zone.dragover { background: rgba(255,255,255,0.2); border-color: white; }
  #file-list { list-style: none; padding: 0; margin-top: 0.5rem; text-align: left; font-size: 0.8rem; max-height: 80px; overflow-y: auto; }
  #file-list li { background: rgba(0,0,0,0.2); padding: 4px 8px; border-radius: 4px; margin-bottom: 4px; animation: fadeIn 0.5s; }
  #progress-bar-container { width: 100%; background: var(--input-bg); border-radius: 8px; overflow: hidden; height: 10px; margin-bottom: 0.8rem; display: none; }
  #progress-bar { width: 0; height: 100%; background: var(--success-color); transition: width 0.3s; }
  .captcha-container { display: flex; align-items: center; gap: 10px; margin-bottom: 0.8rem; }
  #captcha-canvas, #manage-captcha-canvas { background: white; border-radius: 8px; }
  #reload-captcha, #manage-reload-captcha { background: transparent; border: none; padding: 0; cursor: pointer; }
  #my-files-result a { display: block; background: var(--success-color); color: white; padding: 0.8rem; border-radius: 12px; text-decoration: none; font-weight: 600; margin-bottom: 0.5rem; transition: all 0.2s; transform: scale(1); }
  #my-files-result a:hover { background: var(--success-hover); transform: scale(1.02); }
  #my-files-result { margin-top: 1.5rem; text-align: left; }
  .file-bundle { background: var(--tab-bg); padding: 1rem; border-radius: 12px; animation: fadeIn 0.5s; }
  .file-bundle h4 { margin-bottom: 0.5rem; }
  .file-bundle ul { list-style: none; padding-left: 1rem; margin-bottom: 1rem;}
  .file-bundle li { font-size: 0.9rem; opacity: 0.9; }
  .file-bundle button { background: var(--danger-color); color: white; }
  .file-bundle button:hover:not(:disabled) { background: var(--danger-hover); }
  .pin-row { display: flex; align-items: center; gap: 8px; margin-bottom: 0.5rem; }
  .pin-row label { margin-bottom: 0; }
  .pin-error { color: #ef4444; font-size: 0.85rem; display: none; }
</style>
</head>
<body>

<div class="theme-switcher" id="theme-toggle" aria-label="Toggle theme"></div>

<div class="card">
  <div class="logo-container">
    <div class="doc-icon"></div> <div class="lock-icon"></div> <div class="logo-text">MyDocKey</div>
  </div>
  <p class="subtitle">Securely share your files — no login required.</p>
  <div class="tabs">
    <div class="tab active" data-tab="upload">Upload</div>
    <div class="tab" data-tab="my-files">Access Files</div>
  </div>

  <div class="tab-content active" id="upload">
    <input id="username" type="text" placeholder="Choose a Unique Username" required>
    <input id="password" type="password" placeholder="Set Password for these files" required>
    <div id="drop-zone">
        <p>Drag & Drop files here or</p>
        <input id="file" type="file" required multiple style="display:none;">
        <button id="select-file-btn" style="margin-top:0.8rem;padding:0.6rem 1.2rem;font-size:0.9rem;">Select Files</button>
        <ul id="file-list"></ul>
    </div>
    <label for="expiry">Select Expiry Date</label>
    <input id="expiry" type="date" required>
    <div class="pin-row">
      <input type="checkbox" id="pin-toggle" style="width:auto;">
      <label for="pin-toggle">Protect with 4-digit PIN (optional)</label>
      <input id="pin-input" type="password" inputmode="numeric" maxlength="4" placeholder="Enter 4-digit PIN" style="display:none;width:120px;">
    </div>
    <div id="pin-error" class="pin-error"></div>
    <div class="captcha-container">
        <canvas id="captcha-canvas" width="120" height="40"></canvas>
        <input id="captcha-input" type="text" placeholder="Enter CAPTCHA" required style="margin:0;">
        <button id="reload-captcha" title="Reload CAPTCHA" aria-label="Reload CAPTCHA"></button>
    </div>
    <div id="progress-bar-container"><div id="progress-bar"></div></div>
    <button id="upload-btn">Upload Files</button>
  </div>

  <div class="tab-content" id="my-files">
    <p style="font-size:0.9rem; opacity:0.8; margin-bottom:1rem;">Enter your credentials to manage or download your files.</p>
    <input id="manage-username" type="text" placeholder="Enter Username" required>
    <input id="manage-password" type="password" placeholder="Enter Password" required>
    <div class="captcha-container">
        <canvas id="manage-captcha-canvas" width="120" height="40"></canvas>
        <input id="manage-captcha-input" type="text" placeholder="Enter CAPTCHA" required style="margin:0;">
        <button id="manage-reload-captcha" title="Reload CAPTCHA" aria-label="Reload CAPTCHA"></button>
    </div>
    <button id="find-files-btn">ACCESS & DOWNLOAD</button>
    <div id="my-files-result"></div>
  </div>
  
  <div class="footer-container">
    <p class="helpdesk">Contact: <a href="mailto:helpdesk.mydockey@yahoo.com">helpdesk.mydockey@yahoo.com</a></p>
    <p class="credit">Created by Shubham (BCA student) | Enhanced Version</p>
  </div>
</div>

<div id="toast" class="toast"></div>

<div class="modal-overlay" id="welcome-modal">
    <div class="modal-content">
        <h3>🚀 Welcome to MyDocKey Pro!</h3>
        <p>This is a secure and anonymous way to transfer files. No accounts, no logins, just simple and private file sharing.</p>
        <p><strong>How it works:</strong> Upload files under a unique username and password, set an expiry date, and share your credentials. It's that easy!</p>
        <div class="modal-footer"><input type="checkbox" id="hide-welcome"><label for="hide-welcome">Don't show this again</label></div>
        <div class="modal-buttons"><button id="close-welcome" style="width:100%;">Get Started</button></div>
    </div>
</div>

<div class="modal-overlay" id="delete-modal">
    <div class="modal-content">
        <h3>Confirm Deletion</h3>
        <p>Are you sure you want to permanently delete all files for username <strong id="delete-username-confirm"></strong>? This cannot be undone.</p>
        <div class="modal-buttons">
            <button id="modal-cancel-delete" style="background:var(--tab-bg); color:var(--text-color);">Cancel</button>
            <button id="modal-confirm-delete" style="background:var(--danger-color); color:white;">Yes, Delete</button>
        </div>
    </div>
</div>

<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

const supabaseUrl = "https://fucgldfvmnjekbqcucwg.supabase.co";
const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZ1Y2dsZGZ2bW5qZWticWN1Y3dnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk0Njk2NzIsImV4cCI6MjA3NTA0NTY3Mn0.S_Cg3EEwbeFPjQHVUydNHxBssJ3KyyxjPO7qdmnvuGs";
const supabase = createClient(supabaseUrl, supabaseKey);

let filesToUpload = [];
let captchaText = '';
let manageCaptchaText = '';

const getEl = (id) => document.getElementById(id);
const toast = getEl("toast");
const fileInput = getEl('file');
const dropZone = getEl('drop-zone');
const fileListDisplay = getEl('file-list');
const progressBarContainer = getEl('progress-bar-container');
const progressBar = getEl('progress-bar');
const uploadBtn = getEl('upload-btn');

// PIN feature elements
const pinToggle = getEl('pin-toggle');
const pinInput = getEl('pin-input');
const pinError = getEl('pin-error');

pinToggle.addEventListener('change', () => {
  if (pinToggle.checked) {
    pinInput.style.display = 'block';
    pinError.style.display = 'none';
    pinInput.focus();
  } else {
    pinInput.style.display = 'none';
    pinError.style.display = 'none';
    pinInput.value = '';
  }
});

function showToast(msg, duration = 3000) {
  toast.textContent = msg;
  toast.classList.add("show");
  setTimeout(() => toast.classList.remove("show"), duration);
}

function updateFileDisplay() {
  fileListDisplay.innerHTML = '';
  filesToUpload.forEach(f => {
    const li = document.createElement('li');
    li.textContent = f.name;
    fileListDisplay.appendChild(li);
  });
}

function generateCaptcha(canvasId) {
  const canvas = getEl(canvasId);
  const ctx = canvas.getContext('2d');
  const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
  let text = '';
  for (let i = 0; i < 6; i++) {
    text += chars.charAt(Math.floor(Math.random() * chars.length));
  }
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  ctx.fillStyle = '#f0f0f0';
  ctx.fillRect(0, 0, canvas.width, canvas.height);
  ctx.font = 'bold 24px Inter';
  ctx.fillStyle = '#333';
  ctx.textAlign = 'center';
  ctx.textBaseline = 'middle';
  ctx.fillText(text, canvas.width / 2, canvas.height / 2);
  return text;
}
function initCaptcha() {
  captchaText = generateCaptcha('captcha-canvas');
  manageCaptchaText = generateCaptcha('manage-captcha-canvas');
}

async function hashPassword(password) {
  const encoder = new TextEncoder();
  const data = encoder.encode(password);
  const hashBuffer = await crypto.subtle.digest('SHA-256', data);
  return Array.from(new Uint8Array(hashBuffer)).map(b => b.toString(16).padStart(2, '0')).join('');
}

const themeToggle = getEl('theme-toggle');
const sunIcon = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 3v2.25m6.364.386l-1.591 1.591M21 12h-2.25m-.386 6.364l-1.591-1.591M12 18.75V21m-4.773-4.227l-1.591 1.591M5.25 12H3m4.227-4.773L5.636 5.636M15.75 12a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0z" /></svg>`;
const moonIcon = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M21.752 15.002A9.72 9.72 0 0118 15.75c-5.385 0-9.75-4.365-9.75-9.75 0-1.33.266-2.597.748-3.752A9.753 9.753 0 003 11.25C3 16.635 7.365 21 12.75 21a9.753 9.753 0 008.25-4.5c.203-.359.395-.724.552-1.101zM12.75 5.25a7.5 7.5 0 00-7.5 7.5 7.5 7.5 0 007.5 7.5 7.5 7.5 0 007.5-7.5 7.5 7.5 0 00-7.5-7.5z" /></svg>`;
function setTheme(theme) {
  document.documentElement.setAttribute('data-theme', theme);
  themeToggle.innerHTML = theme === 'dark' ? sunIcon : moonIcon;
  localStorage.setItem('theme', theme);
}

document.querySelectorAll('.tab').forEach(tab => {
  tab.addEventListener('click', () => {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
    tab.classList.add('active');
    getEl(tab.dataset.tab).classList.add('active');
  });
});

dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('dragover'); });
dropZone.addEventListener('dragleave', () => dropZone.classList.remove('dragover'));
dropZone.addEventListener('drop', (e) => {
  e.preventDefault();
  dropZone.classList.remove('dragover');
  if (e.dataTransfer.files.length) {
    filesToUpload = Array.from(e.dataTransfer.files);
    updateFileDisplay();
  }
});
getEl('select-file-btn').addEventListener('click', () => fileInput.click());
fileInput.addEventListener('change', () => { filesToUpload = Array.from(fileInput.files); updateFileDisplay(); });

uploadBtn.addEventListener('click', async () => {
  const username = getEl('username').value.trim();
  const password = getEl('password').value.trim();
  const expiry = getEl('expiry').value;
  const captchaInput = getEl('captcha-input').value;

  let pinHash = null;
  if (pinToggle.checked) {
    const pin = pinInput.value.trim();
    if (!/^\d{4}$/.test(pin)) {
      pinError.textContent = 'PIN must be exactly 4 digits';
      pinError.style.display = 'block';
      showToast('❌ PIN must be exactly 4 digits');
      return;
    }
    pinError.style.display = 'none';
    pinHash = await hashPassword(pin);
  } else {
    pinError.style.display = 'none';
  }

  if (!username || !password || filesToUpload.length === 0 || !expiry) { showToast("⚠️ Fill all fields & select files"); return; }
  if (captchaInput.toUpperCase() !== captchaText.toUpperCase()) { showToast("❌ Invalid CAPTCHA"); captchaText = generateCaptcha('captcha-canvas'); return; }

  uploadBtn.disabled = true; uploadBtn.textContent = 'Uploading...';
  progressBarContainer.style.display = 'block'; progressBar.style.width = '0%';
  let uploadedFiles = []; let totalSize = filesToUpload.reduce((acc, file) => acc + file.size, 0); let uploadedSize = 0;

  try {
    const hashedPassword = await hashPassword(password);
    for (const file of filesToUpload) {
      const filePath = `${username}/${file.name}`;
      const { data, error } = await supabase.storage.from('files').upload(filePath, file, { upsert: true });
      if (error) throw error;
      uploadedSize += file.size;
      uploadedFiles.push({ name: file.name, path: filePath });
      progressBar.style.width = ((uploadedSize / totalSize) * 100) + '%';
    }
    const { error: dbError } = await supabase
      .from('files')
      .upsert([{
        username,
        password: hashedPassword,
        files: uploadedFiles,
        expiry,
        uploaded_at: new Date().toISOString(),
        pin_hash: pinHash
      }]);
    if (dbError) throw dbError;
    showToast(`✅ ${uploadedFiles.length} file(s) uploaded!`);
    getEl('username').value = ''; getEl('password').value = ''; filesToUpload = []; updateFileDisplay(); initCaptcha();
    pinToggle.checked = false; pinInput.value = ''; pinInput.style.display = 'none'; pinError.style.display = 'none';
  } catch (error) {
    console.error(error);
    showToast(`❌ Upload failed: ${error.message || error.code || error}`);
  } finally {
    uploadBtn.disabled = false; uploadBtn.textContent = 'Upload Files'; progressBarContainer.style.display = 'none';
  }
});

getEl('find-files-btn').addEventListener('click', async () => {
  const username = getEl('manage-username').value.trim();
  const password = getEl('manage-password').value.trim();
  const captchaInput = getEl('manage-captcha-input').value.trim();
  const resultDiv = getEl('my-files-result');
  resultDiv.innerHTML = '';

  if (!username || !password) { showToast("⚠️ Please enter username and password"); return; }
  if (captchaInput.toUpperCase() !== manageCaptchaText.toUpperCase()) { showToast("❌ Invalid CAPTCHA"); manageCaptchaText = generateCaptcha('manage-captcha-canvas'); return; }

  try {
    const { data, error } = await supabase.from('files').select('*').eq('username', username).single();
    if (error || !data) {
      showToast("❌ No files found for this username");
      resultDiv.innerHTML = `<p>No uploads found.</p>`;
      manageCaptchaText = generateCaptcha('manage-captcha-canvas');
      return;
    }

    const hashedPassword = await hashPassword(password);
    if (hashedPassword !== data.password) {
      showToast("❌ Incorrect password");
      manageCaptchaText = generateCaptcha('manage-captcha-canvas');
      return;
    }

    if (new Date(data.expiry) < new Date()) {
      showToast("⏳ File links have expired");
      resultDiv.innerHTML = `<p>These files expired on ${new Date(data.expiry).toDateString()}.</p>`;
      return;
    }

    if (data.pin_hash) {
      let userPin = prompt('This bundle is protected by a 4-digit PIN. Enter PIN:');
      if (!userPin || !/^\d{4}$/.test(userPin)) {
        showToast('❌ Invalid PIN');
        return;
      }
      const userPinHash = await hashPassword(userPin);
      if (userPinHash !== data.pin_hash) {
        showToast('❌ Incorrect PIN');
        return;
      }
    }

    showToast("✅ Access granted! Fetching links...");

    let downloadLinksHTML = '<div style="margin-top:1rem;">';
    for (const file of data.files) {
      const { data: urlData } = await supabase.storage.from('files').getPublicUrl(file.path);
      downloadLinksHTML += `<a href="${urlData.publicUrl}" download="${file.name}">⬇ Download ${file.name}</a>`;
    }
    downloadLinksHTML += '</div>';

    resultDiv.innerHTML = `<div class="file-bundle"><h4>Files for: ${username}</h4><p style="font-size:0.8rem; opacity:0.8;">Expires on: ${new Date(data.expiry).toDateString()}</p>${downloadLinksHTML}<button id="delete-bundle-btn" data-username="${username}" style="margin-top:1rem;">Delete All Files</button></div>`;
    getEl('delete-bundle-btn').addEventListener('click', (e) => { getEl('delete-username-confirm').textContent = e.target.dataset.username; getEl('delete-modal').style.display = 'flex'; });

  } catch (e) {
    console.error(e);
    showToast(`❌ Error finding files: ${e.message || e.code || e}`);
    manageCaptchaText = generateCaptcha('manage-captcha-canvas');
  }
});

getEl('modal-cancel-delete').addEventListener('click', () => { getEl('delete-modal').style.display = 'none'; });
getEl('modal-confirm-delete').addEventListener('click', async () => {
  const username = getEl('delete-username-confirm').textContent; if (!username) return;
  showToast("🔥 Deleting files...", 4000); getEl('delete-modal').style.display = 'none'; getEl('my-files-result').innerHTML = '';
  try {
    const { data, error } = await supabase.from('files').select('*').eq('username', username).single();
    if (data && data.files) {
      await Promise.all(data.files.map(file => supabase.storage.from('files').remove([file.path])));
      await supabase.from('files').delete().eq('username', username);
      showToast("✅ All files deleted successfully!");
      getEl('manage-username').value = '';
      getEl('manage-password').value = '';
      getEl('manage-captcha-input').value = '';
    }
  } catch (e) {
    console.error("Deletion failed:", e);
    showToast(`❌ Deletion failed: ${e.message || e.code || e}`);
  }
});

window.addEventListener('load', () => {
  const d = new Date(); d.setDate(d.getDate() + 1); const tomorrow = d.toISOString().split('T')[0];
  getEl('expiry').min = tomorrow; getEl('expiry').value = tomorrow;
  const savedTheme = localStorage.getItem('theme') || 'light'; setTheme(savedTheme);
  const welcomeModal = getEl('welcome-modal');
  if (localStorage.getItem('hideWelcome') !== 'true') { welcomeModal.style.display = 'flex'; }
  getEl('close-welcome').addEventListener('click', () => { if (getEl('hide-welcome').checked) { localStorage.setItem('hideWelcome', 'true'); } welcomeModal.style.display = 'none'; });
  const reloadIcon = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0l3.181 3.183a8.25 8.25 0 0011.664 0l3.181-3.183m-4.991-2.693L7.985 5.644m0 0v4.992m0 0h4.992m-4.993 0l3.181-3.183a8.25 8.25 0 0111.664 0l3.181 3.183" /></svg>`;
  getEl('reload-captcha').innerHTML = getEl('manage-reload-captcha').innerHTML = reloadIcon;
  getEl('reload-captcha').addEventListener('click', () => captchaText = generateCaptcha('captcha-canvas'));
  getEl('manage-reload-captcha').addEventListener('click', () => manageCaptchaText = generateCaptcha('manage-captcha-canvas'));
  themeToggle.addEventListener('click', () => { const currentTheme = document.documentElement.getAttribute('data-theme'); setTheme(currentTheme === 'dark' ? 'light' : 'dark'); });
  initCaptcha();
});
</script>
</body>
</html>
